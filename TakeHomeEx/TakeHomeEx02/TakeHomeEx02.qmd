---
title: "Take Home Exercise 2"
author: "Kieren Chua"
date: "August 26 2024"
date-modified: "September 28 2024"
execute: 
    eval: true # evaulate the code first
    echo: true # See the code output
    message: false # don't see the warnings
    freeze: true # Prevent re-render
---

# Part 1 : Reading the Data

```{r}
pacman::p_load("sf", "sfdep", "tidyverse", "tmap", "ggstatsplot", "spatstat", "tmaptools")
```

```{r}
# Read the provincial data and the other data
thailand_csv <- read_csv("data/thailand_domestic_tourism_2019_2023_ver2.csv") %>% mutate(year = year(date)) %>% mutate(month = month(date, label=TRUE))

# There is some missing data
unqiue_province <- unique(thailand_csv$province_eng)

province_shp <- st_read(dsn = "data", layer = "tha_admbnda_adm1_rtsd_20220121") %>% 
                st_transform(crs = 32647) %>%
                select(-ADM1_REF, 
                       -ADM1ALT1EN, 
                       -ADM1ALT2EN, 
                       -ADM1ALT1TH, 
                       -ADM1ALT2TH, 
                       -ADM0_TH, 
                       -ADM0_EN,
                       -ADM0_PCODE,
                       -ADM1_TH) %>%
                rename(province_eng = ADM1_EN) %>% # Rename for spacetime
                filter(province_eng %in% unqiue_province) #Remove missing

# Check for empty geometries
empty_geometries <- st_is_empty(province_shp)
if (any(empty_geometries)) {
    warning("Some geometries are empty.")
} else {
  print("No Empty Geometries")
}
```
Now we can draw out the data 
```{r}
tmap_mode("plot")
tm_shape(province_shp) +
  tm_polygons()
```
```{r}
tmap_mode("plot")
```
# Part 2 : Check if Space & Time - Independent

To check if the data is space independent, we need to see if there is any correlation between the tourist numbers of each region to its neighbors. We shall use a non-COVID time period which is the year of 2019, so that the data is not affected by external factors.

## Creating the Space-Time Layer

```{r}
spacetime_thai_year <- spacetime(thailand_csv, 
                                    .loc_col = "province_eng", 
                                    .time_col= "year",
                                    .geometry = province_shp)
```

Verify that spacetime object has both geometry and data

```{r}
activate(spacetime_thai_year, "data")
```

```{r}
activate(spacetime_thai_year, "geometry")
```

## Global Moran's I Test

```{r}
# TODO : Change to Distance Metrics, Use KnearestNeighbours
wm_q <- province_shp %>% 
        mutate(nb = st_contiguity(geometry),
                wt = st_weights(nb, style = 'W'), # Standardised over neighbours
                .before = 1,
                #zero.viewpolicy = TRUE,
                allow_zero = TRUE) # There seems to be some islands
```

Now we conduct Moran's I for every month and every year
```{r}
unique_month <- unique(thailand_csv$month)
unique_year <- unique(thailand_csv$year) 
```

```{r}
```
